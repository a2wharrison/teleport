#!groovy
pipeline {
    agent any
    options {
        disableConcurrentBuilds()
        ansiColor(colorMapName: 'XTerm')
    }
    stages {
        stage('Run Packer, CloudFormation and wait for stack to be ready') {
            steps {
                dir('assets/marketplace') {
                    script {
                        sh 'make jenkins-test-start'
                    }
                }
            }
        }
        stage('Wait for Teleport Web UI to come up') {
            steps {
                timeout(5) {
                    waitUntil {
                        script {
                            def r = sh script: 'wget -q https://jenkins-teleport-quickstart-test-stack.gravitational.io/web/login', returnStatus: true
                            return (r == 0);
                        }
                    }
                }
            }
        }
        //stage('Take stack down and wait for destruction') {
        //    steps {
        //        dir('assets/marketplace') {
        //            script {
        //                sh 'make jenkins-test-stop'
        //            }
        //        }
        //    }
        //}
    }
}
